# Steam Deck Compatibility Project - Agent Instructions

## Project Overview
Singularity Mod Manager is a Tauri v2 application that manages game modifications. The primary goal has been implementing comprehensive Steam Deck compatibility.

## Technical Architecture
- **Frontend**: HTML/CSS/JavaScript running in WebKit webview
- **Backend**: Rust with Tauri v2 framework
- **Target Platform**: Steam Deck (Arch Linux SteamOS)
- **Distribution**: GitHub Actions CI/CD creating tarball, AppImage, and Flatpak packages

## Steam Deck Compatibility Challenges & Solutions

### 1. Network Layer Issues
**Problem**: WebKit's `fetch()` API is broken on Linux, causing network requests to fail on Steam Deck.

**Solution Implemented**:
- Created Rust HTTP proxy using `reqwest` crate
- Added `http_request` Tauri command in `src-tauri/src/main.rs`
- Replaced all `fetch()` calls in `src/main.js` with `invoke('http_request')`
- Added base64 encoding for binary image data

**Key Files Modified**:
- `src-tauri/src/main.rs`: Added `HttpResponse` struct and `http_request` command
- `src-tauri/Cargo.toml`: Added `base64` dependency
- `src-tauri/tauri.conf.json`: Registered `http_request` command
- `src/main.js`: Converted all network calls to use Tauri proxy

### 2. Environment Variables
**Problem**: Steam Deck requires specific environment variables for proper graphics/accessibility.

**Solution**: 
- `EGL_PLATFORM=x11` - Forces X11 mode for graphics
- `ATK_ADAPTOR=dbus` - Accessibility framework compatibility

**Implementation**: Added Steam Deck detection and environment setup:
```rust
pub fn is_running_on_steam_deck() -> bool {
    std::path::Path::new("/home/deck").exists()
}

pub fn configure_steam_deck_environment() {
    if is_running_on_steam_deck() {
        std::env::set_var("EGL_PLATFORM", "x11");
        std::env::set_var("ATK_ADAPTOR", "dbus");
    }
}
```

### 3. Packaging & Distribution
**Problem**: Local NixOS builds created hardcoded paths, not portable to Steam Deck.

**Solution**: GitHub Actions workflow with clean Ubuntu environment
- **File**: `.github/workflows/build-linux.yml` 
- **Creates**: 3 distribution formats
  1. **Tarball**: `singularity-mm-steam-deck.tar.gz` - Extract and run
  2. **AppImage**: `singularity-mm-steam-deck.AppImage` - Direct execution  
  3. **Flatpak**: `singularity-mm-steam-deck.flatpak` - System integration (recommended for Steam Deck)

### 4. Library Bundling
**Problem**: Steam Deck may lack required libraries.

**Solution**: Comprehensive dependency bundling
- Uses `patchelf` to set `$ORIGIN` relative library paths
- Bundles WebKit, GTK, GLib and application-specific libraries
- Excludes core system libraries (libc, libdl, etc.) to avoid GLIBC conflicts
- Libraries copied to `lib/` directory with proper RPATH configuration

### 5. WebKit Helper Processes
**Current Issue**: WebKit needs helper processes (`WebKitNetworkProcess`) for sandboxed operations.

**Attempted Solutions**:
- Bundle WebKit executables from `/usr/lib/x86_64-linux-gnu/webkit2gtk-4.1/`
- Set `WEBKIT_EXEC_PATH="/app/libexec"` environment variable
- **Status**: Still debugging - WebKit may be looking in wrong paths

## Current Status

### ‚úÖ Working Features
- Steam Deck environment detection
- HTTP proxy replacing WebKit fetch()  
- Image loading via Tauri commands
- Browse tab functionality confirmed working
- Automated CI/CD packaging for all formats
- Library bundling with proper RPATH

### üîß In Progress
- WebKit helper process spawning in Flatpak environment
- Desktop integration and app launcher registration

### üìÅ Key Files to Understand
- `src-tauri/src/main.rs` - Rust backend with Steam Deck compatibility
- `src/main.js` - Frontend with Tauri network proxy calls
- `src-tauri/tauri.conf.json` - Tauri configuration with registered commands
- `.github/workflows/build-linux.yml` - CI/CD pipeline for Steam Deck packages

## Testing Approach
1. **Local Development**: Direct testing on Steam Deck hardware with `npm run tauri dev`
2. **Environment**: Ensure `EGL_PLATFORM=x11` and `ATK_ADAPTOR=dbus` are set
3. **Network Testing**: Verify `invoke('http_request')` calls work correctly
4. **WebKit Debugging**: Monitor console for WebKit process spawning errors

## Next Steps
1. Debug WebKit helper process location in Flatpak
2. Test all three package formats on actual Steam Deck
3. Verify desktop integration works properly
4. Ensure app launcher shows Singularity icon

## Architecture Notes
- **Why WebKit is still needed**: Despite network proxy, WebKit renders the UI, executes JavaScript, and handles DOM manipulation
- **Packaging strategy**: Clean CI/CD environment avoids hardcoded paths from local development environments
- **Distribution preference**: Flatpak is recommended for Steam Deck due to built-in support and system integration