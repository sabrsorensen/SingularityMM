name: Build Application

on:
    pull_request:
        branches: [main]
        paths-ignore:
            - "*.md"
            - "LICENSE"
            - "screenshots/**"
            - ".vscode/**"
            - "flake.nix"
            - "flake.lock"
            - "shell.nix"
            - ".gitignore"
            - ".github/scripts/**"
            - ".github/workflows/update_curated_list.yml"
            - ".github/workflows/publish-flatpak-repo.yml"
    workflow_call:
        inputs:
            release:
                description: "Upload to GitHub Release instead of artifacts"
                type: boolean
                default: false
            tag_name:
                description: "Tag name for release upload"
                type: string
                default: ""
            targets:
                description: "Comma-separated build targets: windows,linux,flatpak"
                type: string
                default: "windows,linux,flatpak"
    workflow_dispatch:
        inputs:
            release:
                description: "Upload to GitHub Release instead of artifacts"
                type: boolean
                default: false
            tag_name:
                description: "Tag name for release upload"
                type: string
                default: ""
            targets:
                description: "Comma-separated build targets: windows,linux,flatpak"
                type: string
                default: "windows,linux,flatpak"

jobs:
    determine-targets:
        name: Determine Build Targets
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.set-matrix.outputs.matrix }}
        steps:
            - id: set-matrix
              run: |
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    # PR builds: Windows and Linux for comprehensive testing
                    echo 'matrix={"include":[{"target":"windows","os":"windows-latest"},{"target":"linux","os":"ubuntu-22.04"}]}' >> $GITHUB_OUTPUT
                  else
                    # Release/manual builds: parse targets input
                    targets="${{ inputs.targets || 'windows,linux,flatpak' }}"
                    matrix='{"include":['

                    if [[ "$targets" == *"windows"* ]]; then
                      matrix+='"{"target":"windows","os":"windows-latest"},'
                    fi
                    if [[ "$targets" == *"linux"* ]]; then
                      matrix+='{"target":"linux","os":"ubuntu-22.04"},'
                    fi
                    if [[ "$targets" == *"flatpak"* ]]; then
                      matrix+='{"target":"flatpak","os":"ubuntu-latest"},'
                    fi

                    # Remove trailing comma and close
                    matrix="${matrix%,}]}"
                    echo "matrix=$matrix" >> $GITHUB_OUTPUT
                  fi

    build:
        name: Build ${{ matrix.target }}
        needs: determine-targets
        runs-on: ${{ matrix.os }}
        strategy:
            matrix: ${{ fromJSON(needs.determine-targets.outputs.matrix) }}
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4

            - name: Extract Version from Tag
              id: version
              if: startsWith(github.ref, 'refs/tags/v') || inputs.tag_name != ''
              shell: bash
              run: |
                  if [ -n "${{ inputs.tag_name }}" ]; then
                    VERSION="${{ inputs.tag_name }}"
                  else
                    VERSION=${GITHUB_REF#refs/tags/v}
                  fi
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "Extracted version: $VERSION"

            - name: Update Version Numbers
              if: steps.version.outputs.version != ''
              shell: bash
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  # Update package.json
                  if [[ "$RUNNER_OS" == "Windows" ]]; then
                    sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" package.json
                    sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
                  else
                    sed -i 's/"version": "[^"]*"/"version": "'$VERSION'"/' package.json
                    sed -i 's/"version": "[^"]*"/"version": "'$VERSION'"/' src-tauri/tauri.conf.json
                  fi

            # === Windows Build ===
            - name: Install Rust (Windows)
              if: matrix.target == 'windows'
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: x86_64-pc-windows-msvc

            - name: Install Node.js (Windows)
              if: matrix.target == 'windows'
              uses: actions/setup-node@v4
              with:
                  node-version: 24

            - name: Install Dependencies (Windows)
              if: matrix.target == 'windows'
              run: npm install

            - name: Build Windows Application
              if: matrix.target == 'windows'
              run: npm run tauri build

            # === Linux Build ===
            - name: Install Linux Dependencies
              if: matrix.target == 'linux'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file \
                    libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev \
                    pkg-config libxdo-dev libxcb-shape0-dev libxcb-xfixes0-dev

            - name: Install Rust (Linux)
              if: matrix.target == 'linux'
              uses: dtolnay/rust-toolchain@stable

            - name: Install Node.js (Linux)
              if: matrix.target == 'linux'
              uses: actions/setup-node@v4
              with:
                  node-version: 24

            - name: Install Dependencies (Linux)
              if: matrix.target == 'linux'
              run: npm install

            - name: Build Linux Application
              if: matrix.target == 'linux'
              run: npm run tauri build

            # === Flatpak Build ===
            - name: Install Flatpak Dependencies
              if: matrix.target == 'flatpak'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y libwebkit2gtk-4.1-dev build-essential curl wget file \
                    libssl-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev \
                    pkg-config flatpak-builder

            - name: Install Rust (Flatpak)
              if: matrix.target == 'flatpak'
              uses: dtolnay/rust-toolchain@stable

            - name: Install Node.js (Flatpak)
              if: matrix.target == 'flatpak'
              uses: actions/setup-node@v4
              with:
                  node-version: 24

            - name: Install Dependencies (Flatpak)
              run: npm install
              if: matrix.target == 'flatpak'

            - name: Build Tauri Application (Flatpak)
              if: matrix.target == 'flatpak'
              run: npm run tauri build -- --no-bundle

            - name: Setup Flatpak Environment
              if: matrix.target == 'flatpak'
              run: |
                  sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
                  sudo flatpak install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49
                  export DCONF_PROFILE=/dev/null
                  flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
                  flatpak --user install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49

            - name: Prepare Flatpak Sources
              if: matrix.target == 'flatpak'
              run: flatpak/copy-resources.sh

            - name: Build Flatpak Package
              if: matrix.target == 'flatpak'
              run: |
                  flatpak-builder --repo=flatpak-repo --force-clean --disable-updates flatpak-build flatpak/com.syzzle.Singularity.json
                  flatpak build-bundle flatpak-repo SingularityMM.flatpak com.syzzle.Singularity

            # === Upload Artifacts ===
            - name: Upload Windows Artifacts
              if: matrix.target == 'windows' && (!inputs.release)
              uses: actions/upload-artifact@v4
              with:
                  name: windows-artifacts
                  path: |
                      src-tauri/target/release/bundle/msi/*.msi
                      src-tauri/target/release/bundle/nsis/*.exe

            - name: Upload Linux Artifacts
              if: matrix.target == 'linux' && (!inputs.release)
              uses: actions/upload-artifact@v4
              with:
                  name: linux-artifacts
                  path: src-tauri/target/release/bundle/appimage/*.AppImage

            - name: Upload Flatpak Artifacts
              if: matrix.target == 'flatpak' && (!inputs.release)
              uses: actions/upload-artifact@v4
              with:
                  name: flatpak-artifacts
                  path: SingularityMM.flatpak

            # === Upload to Release ===
            - name: Upload Windows to Release
              if: matrix.target == 'windows' && inputs.release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ inputs.tag_name }}
                  draft: true
                  prerelease: false
                  files: |
                      src-tauri/target/release/bundle/msi/*.msi
                      src-tauri/target/release/bundle/nsis/*.exe

            - name: Upload Linux to Release
              if: matrix.target == 'linux' && inputs.release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ inputs.tag_name }}
                  draft: true
                  prerelease: false
                  files: src-tauri/target/release/bundle/appimage/*.AppImage

            - name: Upload Flatpak to Release
              if: matrix.target == 'flatpak' && inputs.release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ inputs.tag_name }}
                  draft: true
                  prerelease: false
                  files: SingularityMM.flatpak
