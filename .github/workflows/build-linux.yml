name: Build Steam Deck Compatible Linux

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-steam-deck:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            desktop-file-utils \
            fuse \
            libfuse2 \
            libc6-dev \
            libglib2.0-dev \
            libgdk-pixbuf2.0-dev \
            libpango1.0-dev \
            libcairo2-dev \
            libsoup2.4-dev \
            libjavascriptcoregtk-4.1-dev \
            libatk1.0-dev \
            at-spi2-core \
            flatpak \
            flatpak-builder

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Frontend Dependencies
        run: npm install

      - name: Build Tauri Application
        run: |
          # Build without updater artifacts to avoid signing requirements
          npm run tauri build -- --config '{"bundle":{"createUpdaterArtifacts":false},"plugins":{"updater":{"active":false}}}'

      - name: Prepare Steam Deck Package
        run: |
          # Create package directory
          mkdir -p steam-deck-package/lib steam-deck-package/bin
          
          # Copy the binary (correct name is Singularity)
          cp src-tauri/target/release/Singularity steam-deck-package/bin/
          
          echo "Analyzing binary dependencies..."
          ldd steam-deck-package/bin/Singularity
          
          # Collect ALL dynamic library dependencies (not just non-system ones)
          echo "Collecting all dependencies..."
          ldd steam-deck-package/bin/Singularity | grep "=> /" | awk '{print $3}' | sort -u > all_deps.txt
          
          echo "Found $(wc -l < all_deps.txt) total dependencies"
          
          # Copy all dependencies except absolute system libraries
          while read -r lib; do
            if [[ -f "$lib" && "$lib" != "/lib64/ld-linux-x86-64.so.2" ]]; then
              libname=$(basename "$lib")
              # Exclude core system libraries that should come from Flatpak runtime
              if [[ ! "$libname" =~ ^(libc\.so\.|libdl\.so\.|libpthread\.so\.|libm\.so\.|librt\.so\.|libresolv\.so\.|libnss_.*\.so\.|libutil\.so\.).*$ ]]; then
                if [[ ! -f "steam-deck-package/lib/$libname" ]]; then
                  echo "Copying $lib -> steam-deck-package/lib/$libname"
                  cp "$lib" "steam-deck-package/lib/$libname" || echo "Failed to copy $lib"
                fi
              else
                echo "Excluding system library: $libname (will use Flatpak runtime version)"
              fi
            fi
          done < all_deps.txt
          
          # Also copy commonly needed libraries that might be missing
          for common_lib in /usr/lib/x86_64-linux-gnu/libwebkit2gtk-4.1.so.* \
                           /usr/lib/x86_64-linux-gnu/libgtk-3.so.* \
                           /usr/lib/x86_64-linux-gnu/libgdk-3.so.* \
                           /usr/lib/x86_64-linux-gnu/libglib-2.0.so.*; do
            if [[ -f "$common_lib" ]]; then
              libname=$(basename "$common_lib")
              if [[ ! -f "steam-deck-package/lib/$libname" ]]; then
                echo "Adding common library: $common_lib"
                cp "$common_lib" "steam-deck-package/lib/" || true
              fi
            fi
          done
          
          echo "Total libraries bundled: $(ls -1 steam-deck-package/lib/ | wc -l)"
          echo "Library directory size: $(du -sh steam-deck-package/lib/)"
          
          # Set RPATH for the main binary
          patchelf --set-rpath '$ORIGIN/../lib' steam-deck-package/bin/Singularity
          
          # Fix RPATH for all copied libraries
          for lib in steam-deck-package/lib/*.so*; do
            if [[ -f "$lib" ]]; then
              echo "Setting RPATH for $(basename "$lib")"
              patchelf --set-rpath '$ORIGIN' "$lib" 2>/dev/null || echo "Could not patch $(basename "$lib")"
            fi
          done
          
          # Create launcher script
          cat > steam-deck-package/singularity-mm << 'EOF'
          #!/bin/bash
          
          # Steam Deck compatibility
          export EGL_PLATFORM=x11
          export ATK_ADAPTOR=dbus
          
          # Get the directory of this script
          DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
          
          # Add our lib directory to library path
          export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"
          
          # Run the application
          exec "$DIR/bin/Singularity" "$@"
          EOF
          
          chmod +x steam-deck-package/singularity-mm
          
          # Create desktop entry
          cat > steam-deck-package/singularity-mm.desktop << 'EOF'
          [Desktop Entry]
          Name=Singularity Mod Manager
          Exec=./singularity-mm
          Icon=singularity-mm
          Type=Application
          Categories=Game;Utility;
          Comment=Manage your game modifications
          EOF
          
          echo "Package contents:"
          find steam-deck-package -type f | sort
          echo "Total package size: $(du -sh steam-deck-package/)"

      - name: Create Tarball
        run: |
          tar -czf singularity-mm-steam-deck.tar.gz -C steam-deck-package .
          echo "Created tarball: $(ls -lh singularity-mm-steam-deck.tar.gz)"

      - name: Download AppImageTool
        run: |
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

      - name: Create AppImage
        run: |
          # Prepare AppDir structure
          mkdir -p AppDir/usr/bin AppDir/usr/lib
          
          # Copy files to AppDir
          cp -r steam-deck-package/* AppDir/usr/
          
          # Copy icon from Tauri icons
          cp src-tauri/icons/128x128.png AppDir/singularity-mm.png
          
          # Binary is already in the right place: AppDir/usr/bin/Singularity
          # No need to move it
          
          # Update launcher script for AppImage
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          
          # Steam Deck compatibility
          export EGL_PLATFORM=x11
          export ATK_ADAPTOR=dbus
          
          # AppImage environment
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="$HERE/usr/lib:$LD_LIBRARY_PATH"
          
          # Run the application
          exec "$HERE/usr/bin/Singularity" "$@"
          EOF
          
          chmod +x AppDir/AppRun
          
          # Create proper desktop entry for AppImage
          cat > AppDir/singularity-mm.desktop << 'EOF'
          [Desktop Entry]
          Name=Singularity Mod Manager
          Exec=Singularity
          Icon=singularity-mm
          Type=Application
          Categories=Utility;
          Comment=Manage your game modifications
          EOF
          
          # Create AppImage
          ./appimagetool --appimage-extract-and-run AppDir singularity-mm-steam-deck.AppImage

      - name: Setup Flatpak
        run: |
          # Add Flathub repository
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          
          # Install required runtime and SDK (use current version)
          sudo flatpak install -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08
          
          # Setup user flatpak for build isolation (suppress dconf warnings)
          export DCONF_PROFILE=/dev/null
          flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak --user install -y flathub org.freedesktop.Platform//24.08 org.freedesktop.Sdk//24.08

      - name: Create Flatpak
        run: |
          # Create Flatpak manifest with simpler approach
          cat > com.syzzle.singularity.json << 'EOF'
          {
            "app-id": "com.syzzle.singularity",
            "runtime": "org.freedesktop.Platform",
            "runtime-version": "24.08",
            "sdk": "org.freedesktop.Sdk",
            "command": "singularity-wrapper",
            "finish-args": [
              "--share=network",
              "--share=ipc",
              "--socket=fallback-x11",
              "--socket=wayland",
              "--device=dri",
              "--filesystem=home",
              "--filesystem=xdg-download",
              "--filesystem=xdg-documents",
              "--env=EGL_PLATFORM=x11",
              "--env=ATK_ADAPTOR=dbus"
            ],
            "modules": [
              {
                "name": "singularity",
                "buildsystem": "simple",
                "build-commands": [
                  "mkdir -p /app/bin /app/lib /app/share/applications /app/share/icons/hicolor/128x128/apps",
                  "install -m755 Singularity /app/bin/singularity",
                  "for lib in lib/*.so*; do if [[ ! $(basename \"$lib\") =~ ^(libc|libdl|libpthread|libm|librt|libresolv|libnss_|libutil)\\. ]]; then cp \"$lib\" /app/lib/; fi; done",
                  "install -m755 singularity-wrapper /app/bin/singularity-wrapper",
                  "install -m644 singularity.desktop /app/share/applications/com.syzzle.singularity.desktop",
                  "install -m644 singularity.png /app/share/icons/hicolor/128x128/apps/com.syzzle.singularity.png"
                ],
                "sources": [
                  {
                    "type": "dir",
                    "path": "flatpak-source"
                  }
                ]
              }
            ]
          }
          EOF
          
          # Prepare Flatpak source directory
          mkdir -p flatpak-source
          echo "Copying files to flatpak-source..."
          
          # Copy binary and libraries
          cp steam-deck-package/bin/Singularity flatpak-source/
          cp -r steam-deck-package/lib flatpak-source/
          cp src-tauri/icons/128x128.png flatpak-source/singularity.png
          
          # Create wrapper script
          cat > flatpak-source/singularity-wrapper << 'EOF'
          #!/bin/bash
          export LD_LIBRARY_PATH="/app/lib:$LD_LIBRARY_PATH"
          export EGL_PLATFORM=x11
          export ATK_ADAPTOR=dbus
          exec /app/bin/singularity "$@"
          EOF
          
          # Create Flatpak desktop file  
          cat > flatpak-source/singularity.desktop << 'EOF'
          [Desktop Entry]
          Name=Singularity Mod Manager
          Exec=singularity-wrapper
          Icon=com.syzzle.singularity
          Type=Application
          Categories=Utility;Game;
          Comment=Manage your game modifications
          Keywords=mods;modding;games;
          EOF
          
          echo "Flatpak source directory contents:"
          ls -la flatpak-source/
          
          # Build Flatpak with user installation and disable sandboxing
          echo "Building Flatpak..."
          mkdir -p flatpak-build flatpak-repo
          
          # Use --disable-rofiles-fuse to avoid FUSE issues in CI
          flatpak-builder --user --install-deps-from=flathub --disable-rofiles-fuse --force-clean --repo=flatpak-repo flatpak-build com.syzzle.singularity.json
          
          echo "Flatpak build successful, creating bundle..."
          # Export to .flatpak file
          flatpak build-bundle flatpak-repo singularity-mm-steam-deck.flatpak com.syzzle.singularity
          echo "Flatpak bundle created successfully"
          ls -lh singularity-mm-steam-deck.flatpak

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: steam-deck-builds
          path: |
            singularity-mm-steam-deck.tar.gz
            singularity-mm-steam-deck.AppImage
            singularity-mm-steam-deck.flatpak

      - name: Create Release (on push to main)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "steam-deck-${{ github.run_number }}"
          name: "Steam Deck Build #${{ github.run_number }}"
          body: |
            Steam Deck compatible build with bundled dependencies.
            
            **Installation Options:**
            - **Flatpak** (Recommended for Steam Deck): Install via `flatpak install singularity-mm-steam-deck.flatpak` or Discover
            - **Tarball**: Extract anywhere and run `./singularity-mm`
            - **AppImage**: Make executable and run directly
            
            **Steam Deck Setup:**
            1. Switch to Desktop Mode
            2. Download and extract/run the package
            3. The launcher will automatically set required environment variables
            
            Built with Steam Deck compatibility features and bundled dependencies.
          files: |
            singularity-mm-steam-deck.tar.gz
            singularity-mm-steam-deck.AppImage
            singularity-mm-steam-deck.flatpak
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
