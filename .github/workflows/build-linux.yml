name: Build Linux (Flatpak, AppImage, Tarball)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf \
            flatpak \
            flatpak-builder

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Frontend Dependencies
        run: npm install

      - name: Build Tauri Binary
        run: |
          # Clean previous build artifacts
          echo "Cleaning previous build artifacts..."
          rm -rf flatpak-build flatpak-repo .flatpak-builder portable-package flatpak-source
          mkdir -p flatpak-build flatpak-repo portable-package/{bin,lib} flatpak-source
          scripts/build-binary.sh

          # Copy the binary
          echo "Copying Singularity binary..."
          cp src-tauri/target/release/Singularity portable-package/bin/

          # Analyze and copy dynamic library dependencies
          echo "Analyzing binary dependencies..."
          if [[ ! -f portable-package/bin/Singularity ]]; then
            echo "Error: Binary not found at portable-package/bin/Singularity"
            exit 1
          fi
          ldd portable-package/bin/Singularity | grep "=> /" | awk '{print $3}' | sort -u > all_deps.txt

          # Copy dependencies, excluding libraries provided by the target system
          while read -r lib; do
            if [[ -f "$lib" && "$lib" != "/lib64/ld-linux-x86-64.so.2" ]]; then
              libname=$(basename "$lib")
              # Exclude core system libraries, compiler runtimes, and common runtime libraries
              if [[ ! "$libname" =~ ^(libc\.so\.|libdl\.so\.|libpthread\.so\.|libm\.so\.|librt\.so\.|libresolv\.so\.|libnss_.*\.so\.|libutil\.so\.|ld-linux.*|libstdc\+\+\.so\.|libgcc_s\.so\.|libgtk-3\.so\.|libgdk-3\.so\.|libgdk_pixbuf-2\.0\.so\.|libglib-2\.0\.so\.|libgobject-2\.0\.so\.|libpango-1\.0\.so\.|libpangocairo-1\.0\.so\.|libpangoft2-1\.0\.so\.|libatk-1\.0\.so\.|libatk-bridge-2\.0\.so\.|libcairo\.so\.|libcairo-gobject\.so\.|libgio-2\.0\.so\.|libmount\.so\.1$|libblkid\.so\.1$|libsystemd\.so\.|libatspi\.so\.|libjson-glib-1.0\.so\.|libgpg-error\.so\.|libgcrypt\.so\.|libwebkit2gtk.*|libjavascriptcoregtk.*|libc\.so.*).*$ ]]; then
                if [[ ! -f "portable-package/lib/$libname" ]]; then
                  echo "Copying $lib -> portable-package/lib/$libname"
                  cp "$lib" "portable-package/lib/$libname" || echo "Failed to copy $lib"
                fi
              else
                echo "Excluding runtime library: $libname"
              fi
            fi
          done < all_deps.txt

          # Remove problematic libraries that conflict with Flatpak runtime
          rm -f portable-package/lib/libmount.so.1 portable-package/lib/libblkid.so.1

          echo "Total libraries bundled: $(ls -1 portable-package/lib/ 2>/dev/null | wc -l)"

          # Create launcher script for tarball/AppImage
          cat > portable-package/singularity-mm << 'EOF'
          #!/bin/bash
          # Linux compatibility (X11 backend for WebKitGTK)
          export GDK_BACKEND=x11
          export EGL_PLATFORM=x11
          export ATK_ADAPTOR=dbus

          # Get the directory of this script
          DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

          # Add our lib directory to library path
          export LD_LIBRARY_PATH="$DIR/lib:$LD_LIBRARY_PATH"

          # Run the application
          exec "$DIR/bin/Singularity" "$@"
          EOF
          chmod +x portable-package/singularity-mm

          # Create desktop entry for tarball from template
          if [[ ! -f flatpak/singularity-mm.desktop.template ]]; then
            echo "Error: Desktop template not found at flatpak/singularity-mm.desktop.template"
            exit 1
          fi
          sed \
            -e 's|^Exec=.*$|Exec=./singularity-mm|' \
            -e 's|^Icon=.*$|Icon=singularity-mm|' \
            flatpak/singularity-mm.desktop.template > portable-package/singularity-mm.desktop

          echo "Package contents:"
          find portable-package -type f | sort
          echo "Total package size: $(du -sh portable-package/)"

      - name: Create Tarball
        run: |
          tar -czf SingularityMM-Linux.tar.gz -C portable-package .
          echo "Created tarball: $(ls -lh SingularityMM-Linux.tar.gz)"

      - name: Download AppImageTool
        run: |
          wget -O appimagetool https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool

      - name: Create AppImage
        run: |
          # Prepare AppDir structure
          mkdir -p AppDir/usr/bin AppDir/usr/lib

          # Copy files to AppDir
          cp -r portable-package/* AppDir/usr/

          # Copy icon from Tauri icons
          if [[ ! -f src-tauri/icons/128x128.png ]]; then
            echo "Error: Icon not found at src-tauri/icons/128x128.png"
            exit 1
          fi
          cp src-tauri/icons/128x128.png AppDir/singularity-mm.png

          # Update launcher script for AppImage
          cat > AppDir/AppRun << 'EOF'
          #!/bin/bash
          # Linux compatibility (X11 backend for WebKitGTK)
          export GDK_BACKEND=x11
          export EGL_PLATFORM=x11
          export ATK_ADAPTOR=dbus

          # AppImage environment
          HERE="$(dirname "$(readlink -f "${0}")")"
          export LD_LIBRARY_PATH="$HERE/usr/lib:$LD_LIBRARY_PATH"

          # Run the application
          exec "$HERE/usr/bin/Singularity" "$@"
          EOF
          chmod +x AppDir/AppRun

          # Create proper desktop entry for AppImage from template
          sed \
            -e 's|^Exec=.*$|Exec=Singularity|' \
            -e 's|^Icon=.*$|Icon=singularity-mm|' \
            flatpak/singularity-mm.desktop.template > AppDir/singularity-mm.desktop

          # Create AppImage
          ./appimagetool --appimage-extract-and-run AppDir SingularityMM-Linux.AppImage
          echo "Created AppImage: $(ls -lh SingularityMM-Linux.AppImage)"

      - name: Setup Flatpak
        run: |
          # Add Flathub repository
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

          # Install GNOME runtime and SDK matching the manifest
          sudo flatpak install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49

          # Setup user flatpak for build isolation
          export DCONF_PROFILE=/dev/null
          flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak --user install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49

      - name: Prepare Flatpak Source
        run: |
          scripts/flatpak/copy-resources.sh

      - name: Build Flatpak
        run: |
          scripts/flatpak/build-flatpak.sh

          echo "Flatpak build complete!"
          ls -lh SingularityMM.flatpak

      - name: Verify Build Artifacts
        run: |
          for file in SingularityMM-Linux.tar.gz SingularityMM-Linux.AppImage SingularityMM.flatpak; do
            if [[ ! -f "$file" ]]; then
              echo "Error: Required artifact missing: $file"
              exit 1
            fi
            echo "Found: $file ($(du -h "$file" | cut -f1))"
          done

      - name: Upload Tarball
        uses: actions/upload-artifact@v4
        with:
          name: SingularityMM-Linux-Tarball
          path: SingularityMM-Linux.tar.gz

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: SingularityMM-Linux-AppImage
          path: SingularityMM-Linux.AppImage

      - name: Upload Flatpak
        uses: actions/upload-artifact@v4
        with:
          name: SingularityMM-Flatpak
          path: SingularityMM.flatpak

      - name: Create Release (on push to main)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "linux-${{ github.run_number }}"
          name: "Linux Build #${{ github.run_number }}"
          body: |
            Linux builds for desktop Linux systems and Steam Deck.

            **Installation Options:**

            **Flatpak** (Recommended):
            ```bash
            flatpak install SingularityMM.flatpak
            ```
            Or use your system's software center (Discover, GNOME Software, etc.)

            **Tarball** (Portable):
            ```bash
            tar -xzf SingularityMM-Linux.tar.gz
            cd singularity
            ./singularity-mm
            ```

            **AppImage** (Portable):
            ```bash
            chmod +x SingularityMM-Linux.AppImage
            ./SingularityMM-Linux.AppImage
            ```

            **Features:**
            - Linux and Steam Deck compatible
            - X11 and Wayland support via WebKitGTK
            - Bundled dependencies for maximum compatibility
            - Automatic environment configuration
          files: |
            SingularityMM-Linux.tar.gz
            SingularityMM-Linux.AppImage
            SingularityMM.flatpak
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
