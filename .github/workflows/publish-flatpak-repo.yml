name: Publish Flatpak Repo

on:
  push:
    tags:
      - "v*"
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            build-essential \
            curl \
            wget \
            file \
            libssl-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            flatpak \
            flatpak-builder

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Install Frontend Dependencies
        run: npm install

      - name: Build Binary
        run: |
          export PATH="$PATH:$(pwd)/node_modules/.bin"
          npm run tauri build -- --no-bundle

      - name: Setup Flatpak
        run: |
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49

          export DCONF_PROFILE=/dev/null
          flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak --user install -y flathub org.gnome.Platform//49 org.gnome.Sdk//49
      - name: Setup GPG for Repo Signing
        run: |
          # Import CI GPG private key
          echo "${{ secrets.FLATPAK_GPG_PRIVATE_KEY }}" | gpg --batch --import

          # Get key ID for signing (get the specific CI key we just imported)
          GPG_KEY_ID=$(gpg --list-secret-keys --with-colons singularityci@sam.nesneros.space | grep sec | head -1 | cut -d':' -f5)
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV
          echo "Using GPG key: $GPG_KEY_ID"

          # Verify we can sign
          echo "test" | gpg --batch --yes --sign --armor --local-user $GPG_KEY_ID > /dev/null

          # Export public key for repo metadata
          gpg --armor --export $GPG_KEY_ID > flatpak-repo-signing.asc

      - name: Prepare Flatpak Source
        run: flatpak/copy-resources.sh

      - name: Build Flatpak and Export to OSTree Repo
        run: |
          flatpak-builder --repo=flatpak-repo --force-clean --disable-updates flatpak-build flatpak/com.syzzle.Singularity.json

          # Sign the repository with GPG
          flatpak build-update-repo --generate-static-deltas --prune --prune-depth=1 --gpg-sign=$GPG_KEY_ID flatpak-repo

          # Copy GPG public key to repo for client verification
          cp flatpak-repo-signing.asc flatpak-repo/

      - name: Determine Channel
        id: channel
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "name=dev" >> "$GITHUB_OUTPUT"
          else
            echo "name=repo" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to GitHub Pages
        run: |
          CHANNEL="${{ steps.channel.outputs.name }}"
          echo "Deploying to channel: $CHANNEL"

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone gh-pages branch
          git clone --branch gh-pages --single-branch "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages-deploy

          # Replace the channel directory with the new repo
          rm -rf "gh-pages-deploy/${CHANNEL}"
          cp -r flatpak-repo "gh-pages-deploy/${CHANNEL}"

          # Copy the landing page to root
          cp flatpak/gh-pages-index.html gh-pages-deploy/index.html

          # Commit and push
          cd gh-pages-deploy
          git add -A

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update ${CHANNEL} flatpak repo ($(date -u +%Y-%m-%dT%H:%M:%SZ))"
            git push origin gh-pages
            echo "Successfully deployed to GitHub Pages"
          fi
